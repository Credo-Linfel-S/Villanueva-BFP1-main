name: Monthly Leave Accrual

on:
  schedule:
    - cron: '0 18 1 * *'
  workflow_dispatch:

jobs:
  accrual:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Debug environment
        run: |
          echo "=== Debug Info ==="
          echo "Checking secrets..."
          echo "SUPABASE_URL exists in secrets: ${{ secrets.SUPABASE_URL != '' }}"
          echo "SUPABASE_SERVICE_KEY exists: ${{ secrets.SUPABASE_SERVICE_KEY != '' }}"
          echo "=================="
      
      - name: Install dependencies
        run: |
          cd server
          npm install
      
      - name: Run with inline script
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
        run: |
          cd server
          
          node -e "
          // Debug logging
          console.log('=== DEBUG ===');
          console.log('SUPABASE_URL:', process.env.SUPABASE_URL ? process.env.SUPABASE_URL.substring(0, 30) + '...' : 'NOT SET');
          console.log('SUPABASE_SERVICE_KEY exists:', !!process.env.SUPABASE_SERVICE_KEY);
          console.log('=============');
          
          if (!process.env.SUPABASE_URL) {
            console.error('❌ SUPABASE_URL is not set!');
            console.error('Check GitHub Secrets configuration');
            process.exit(1);
          }
          
          if (!process.env.SUPABASE_URL.startsWith('https://')) {
            console.error('❌ Invalid URL format. Must start with https://');
            console.error('Current:', process.env.SUPABASE_URL);
            process.exit(1);
          }
          
          // Force 1st of month
          const originalDate = global.Date;
          global.Date = class extends Date {
            getDate() { return 1; }
          };
          
          // Now run the accrual
          const { addMonthlyAccruals } = require('./cron/monthly-accrual');
          
          addMonthlyAccruals()
            .then(() => {
              console.log('✅ Success!');
              process.exit(0);
            })
            .catch(err => {
              console.error('❌ Error:', err.message);
              process.exit(1);
            });
          "