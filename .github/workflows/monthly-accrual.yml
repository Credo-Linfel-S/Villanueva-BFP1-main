name: BFP Monthly Leave Accrual

on:
  schedule:
    # 2:00 AM Manila time on 1st of every month
    - cron: '0 18 1 * *'
  workflow_dispatch:

jobs:
  run-accrual:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Run Accrual Script
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
        run: |
          # Create a standalone script that has everything
          cat > run-accrual.js << 'EOF'
          // Standalone accrual runner - NO DEPENDENCIES NEEDED!
          console.log('ğŸš€ BFP Leave Accrual - Standalone Runner');
          
          // Get credentials from environment
          const supabaseUrl = process.env.SUPABASE_URL;
          const supabaseKey = process.env.SUPABASE_SERVICE_KEY;
          
          console.log('URL:', supabaseUrl?.substring(0, 30) + '...');
          console.log('Key exists:', !!supabaseKey);
          
          // Force 1st of month
          const originalDate = global.Date;
          global.Date = class extends Date {
            getDate() { return 1; }
          };
          
          // Use native fetch - no Supabase library needed!
          async function runAccrual() {
            console.log('Running accrual logic...');
            
            // 1. Get all active employees
            const employees = await fetchData('personnel?status=eq.Active&is_active=eq.true');
            console.log(`Found ${employees?.length || 0} active employees`);
            
            // 2. For each employee, add 1.25 days
            for (const emp of employees || []) {
              await updateLeaveBalance(emp.id);
            }
            
            console.log('âœ… Accrual completed!');
          }
          
          async function fetchData(query) {
            const response = await fetch(
              `${supabaseUrl}/rest/v1/${query}`,
              {
                headers: {
                  'apikey': supabaseKey,
                  'Authorization': `Bearer ${supabaseKey}`,
                  'Content-Type': 'application/json'
                }
              }
            );
            
            if (!response.ok) {
              throw new Error(`HTTP ${response.status}: ${await response.text()}`);
            }
            
            return await response.json();
          }
          
          async function updateLeaveBalance(personnelId) {
            const currentYear = new Date().getFullYear();
            
            // Get current balance
            const balances = await fetchData(
              `leave_balances?personnel_id=eq.${personnelId}&year=eq.${currentYear}`
            );
            
            if (balances && balances.length > 0) {
              const balance = balances[0];
              
              // Add 1.25 days to each leave type
              const updated = {
                vacation_balance: (parseFloat(balance.vacation_balance) + 1.25).toFixed(3),
                sick_balance: (parseFloat(balance.sick_balance) + 1.25).toFixed(3),
                emergency_balance: (parseFloat(balance.emergency_balance) + 1.25).toFixed(3),
                updated_at: new Date().toISOString()
              };
              
              // Update in database
              await fetch(
                `${supabaseUrl}/rest/v1/leave_balances?id=eq.${balance.id}`,
                {
                  method: 'PATCH',
                  headers: {
                    'apikey': supabaseKey,
                    'Authorization': `Bearer ${supabaseKey}`,
                    'Content-Type': 'application/json',
                    'Prefer': 'return=minimal'
                  },
                  body: JSON.stringify(updated)
                }
              );
              
              console.log(`Updated employee ${personnelId}: +1.25 days`);
            }
          }
          
          // Run it!
          runAccrual().catch(err => {
            console.error('âŒ Error:', err.message);
            process.exit(1);
          });
          EOF
          
          # Run the standalone script
          node run-accrual.js
      
      - name: Cleanup
        run: rm -f run-accrual.js
      
      - name: Success Message
        if: success()
        run: |
          echo "ğŸ‰ SUCCESS! Monthly leave accrual completed."
          echo "All active employees received 1.25 days leave credit."