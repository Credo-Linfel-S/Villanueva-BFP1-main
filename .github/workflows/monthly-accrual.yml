name: Monthly Leave Accrual

on:
  schedule:
    - cron: '0 18 1 * *'  # 2:00 AM Manila = 6:00 PM UTC
  workflow_dispatch:

jobs:
  accrual:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'  # Use Node 20 to match Supabase 2.89.0
      
      - name: Clean install (skip lock file)
        run: |
          cd server
          # Use npm install instead of npm ci to avoid lock file issues
          npm install --no-package-lock
      
      - name: Run monthly accrual
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
        run: |
          cd server
          
          node -e "
          console.log('üöÄ Starting monthly accrual...');
          console.log('Node version:', process.version);
          
          // Load environment
          require('dotenv').config({ path: '.env' });
          
          // Debug: Check environment
          console.log('SUPABASE_URL loaded:', !!process.env.SUPABASE_URL);
          
          // Force 1st of month
          const originalDate = global.Date;
          global.Date = class extends Date {
            getDate() { return 1; }
          };
          
          // Import and run
          const { addMonthlyAccruals } = require('./cron/monthly-accrual');
          
          addMonthlyAccruals()
            .then(() => {
              console.log('‚úÖ Monthly accrual completed successfully!');
              process.exit(0);
            })
            .catch(error => {
              console.error('‚ùå Monthly accrual failed:', error.message);
              console.error('Stack:', error.stack);
              process.exit(1);
            });
          "
      
      - name: Success notification
        if: success()
        run: |
          echo "‚úÖ Monthly leave accrual completed!"
          echo "Time: $(date)"
          echo "All active employees received 1.25 days credit."
      
      - name: Failure notification
        if: failure()
        run: |
          echo "‚ùå Monthly accrual failed!"
          echo "Check logs above for details."