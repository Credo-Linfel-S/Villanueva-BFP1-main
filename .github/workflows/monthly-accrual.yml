name: BFP Monthly Leave Accrual

on:
  schedule:
    - cron: '0 18 1 * *'  # 2:00 AM Manila = 6:00 PM UTC
  workflow_dispatch:

jobs:
  run-accrual:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install dependencies
        run: |
          cd server
          npm install
      
      - name: Create environment file
        run: |
          echo "SUPABASE_URL=${{ secrets.SUPABASE_URL }}" > server/.env
          echo "SUPABASE_SERVICE_ROLE_KEY=${{ secrets.SUPABASE_SERVICE_KEY }}" >> server/.env
          echo "NODE_ENV=production" >> server/.env
      
      - name: Run BFP Accrual Script
        run: |
          cd server
          echo "ðŸš€ Running BFP Monthly Accrual from GitHub Actions"
          echo "Date: $(date)"
          
          # Use actual current date (system will check if it's the 1st)
          node ./cron/monthly-accrual.js
      
      - name: Cleanup
        run: rm -f server/.env
      
      - name: Success notification
        if: success()
        run: echo "âœ… BFP monthly leave accrual completed successfully!"